"""
XSS Scanner
"""

import requests
from urllib.parse import urlparse, parse_qs, urlencode, urlunparse

from rich.console import Console
from rich.panel import Panel

from redai.core.display import display
from redai.core.utils import suggest_ai_analysis
from redai.database.repository import save_scan


console = Console()

XSS_PAYLOADS = [
    "<script>alert('XSS')</script>",
    "<img src=x onerror=alert('XSS')>",
    "<svg onload=alert('XSS')>",
    "javascript:alert('XSS')",
    "'><script>alert('XSS')</script>",
    "\"><script>alert('XSS')</script>",
    "<body onload=alert('XSS')>",
]


def xss(url: str, project: str = "General", auto: bool = False):
    """Esc√°ner de XSS Reflejado en par√°metros GET."""
    if not auto:
        display.header(f"XSS Scanner: {url}")
    
    if not url.startswith("http"):
        url = f"http://{url}"
    
    parsed = urlparse(url)
    params = parse_qs(parsed.query)
    
    if not params:
        display.warning("No parameters found in URL. Add ?param=value")
        return
    
    vulnerable = False
    findings = []
    
    for param in params:
        display.step(f"Testing parameter: {param}")
        
        for payload in XSS_PAYLOADS:
            test_params = params.copy()
            test_params[param] = [payload]
            
            test_url = urlunparse((
                parsed.scheme, parsed.netloc, parsed.path,
                parsed.params, urlencode(test_params, doseq=True), parsed.fragment
            ))
            
            try:
                response = requests.get(test_url, timeout=5)
                
                # Check if payload is reflected
                if payload in response.text:
                    msg = f"üö® VULNERABLE: {param} reflects payload: {payload[:30]}..."
                    findings.append(msg)
                    console.print(f"[bold red]{msg}[/bold red]")
                    vulnerable = True
                    break
                        
            except requests.RequestException:
                continue
    
    out = "\n".join(findings) if findings else "‚ùå No XSS vulnerabilities found."
    
    if not auto:
        style = "red" if vulnerable else "green"
        console.print(Panel(out, style=style))
    
    suggest_ai_analysis(out, "XSS Scan")
    save_scan(target=url, command_type="xss", output=out, project_name=project)
