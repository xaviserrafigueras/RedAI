"""
Exploit Search - SearchSploit integration
"""

import shutil
import subprocess

from rich.console import Console
from rich.panel import Panel

from redai.core.display import display
from redai.core.utils import suggest_ai_analysis
from redai.ai.client import ask_ai_logic
from redai.database.repository import save_scan


console = Console()


def search_exploits(query: str, project: str = "General", auto: bool = False):
    """Busca exploits usando searchsploit (local) y consulta IA."""
    display.header(f"Exploit Search: {query}")
    
    results = []
    
    # SearchSploit (local)
    if shutil.which("searchsploit"):
        display.step("Searching local exploit-db...")
        try:
            proc = subprocess.run(
                ["searchsploit", query, "--json"],
                capture_output=True, text=True
            )
            
            if proc.returncode == 0 and proc.stdout:
                import json
                try:
                    data = json.loads(proc.stdout)
                    exploits = data.get("RESULTS_EXPLOIT", [])
                    
                    for exp in exploits[:10]:  # Limit to 10
                        title = exp.get("Title", "N/A")
                        path = exp.get("Path", "N/A")
                        results.append(f"ðŸ“„ {title}\n   Path: {path}")
                        
                except json.JSONDecodeError:
                    results.append(proc.stdout[:1000])
                    
        except Exception as e:
            display.warning(f"SearchSploit error: {e}")
    else:
        display.warning("SearchSploit not installed. Install: sudo apt install exploitdb")
    
    # AI Supplement
    display.step("Consulting AI for additional CVEs...")
    ai_response = ask_ai_logic(
        f"List 5 known CVEs and exploits for: {query}. "
        "Include CVE ID, brief description, and exploit type. Be concise."
    )
    
    if ai_response and "Error" not in ai_response:
        results.append(f"\nðŸ¤– AI Suggestions:\n{ai_response}")
    
    output = "\n\n".join(results) if results else "No exploits found."
    
    console.print(Panel(output, title="Exploit Results", border_style="red"))
    suggest_ai_analysis(output, "Exploit Search")
    save_scan(query, "exploit_search", output, project_name=project)
