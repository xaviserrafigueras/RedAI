"""
Hash Cracker - Dictionary and Incremental
"""

import os
import string
import hashlib
import itertools

from rich.console import Console
from rich.panel import Panel
from rich.progress import track

from redai.core.display import display
from redai.core.utils import suggest_ai_analysis
from redai.database.repository import save_scan


console = Console()


def crack(
    hash_str: str,
    project: str = "General",
    mode: str = "dictionary",
    wordlist: str = "rockyou.txt",
    max_length: int = 4,
    auto: bool = False
):
    """Crackeo de hashes (Diccionario o Incremental)."""
    if not auto:
        display.header(f"Hash Cracker: {hash_str[:20]}...")
    
    # Identify hash type
    length = len(hash_str)
    algo = "MD5" if length == 32 else "SHA1" if length == 40 else "SHA-256" if length == 64 else "Unknown"
    
    display.info(f"Detected: {algo} ({length} chars)")
    
    gen = None
    if mode == "dictionary":
        paths = [wordlist, "/usr/share/wordlists/rockyou.txt", "wordlist.txt"]
        path = next((r for r in paths if os.path.exists(r) and not r.endswith(".gz")), None)
        
        if path:
            def fg():
                with open(path, "r", encoding="latin-1", errors="ignore") as f:
                    for line in f:
                        yield line.strip()
            gen = fg()
        else:
            gen = iter(["123456", "admin", "root", "password", "test"])
    else:
        # Incremental mode
        chars = string.ascii_letters + string.digits
        def bg():
            for length in range(1, max_length + 1):
                for combo in itertools.product(chars, repeat=length):
                    yield "".join(combo)
        gen = bg()
    
    found = None
    checked = 0
    
    display.step(f"Cracking with {mode} mode...")
    
    try:
        for word in gen:
            checked += 1
            
            # Calculate hash
            if algo == "MD5":
                calc = hashlib.md5(word.encode()).hexdigest()
            elif algo == "SHA1":
                calc = hashlib.sha1(word.encode()).hexdigest()
            elif algo == "SHA-256":
                calc = hashlib.sha256(word.encode()).hexdigest()
            else:
                calc = hashlib.md5(word.encode()).hexdigest()
            
            if calc.lower() == hash_str.lower():
                found = word
                break
                
            if checked % 10000 == 0:
                console.print(f"[dim]Checked {checked} words...[/dim]", end="\r")
                
            if checked > 100000:  # Safety limit
                break
                
    except KeyboardInterrupt:
        display.warning("Interrupted by user.")
    
    out = f"ðŸŽ‰ CRACKED: {found}" if found else f"âŒ Not found after {checked} attempts."
    
    if not auto:
        console.print(Panel(out, style="green" if found else "red"))
    
    if found:
        suggest_ai_analysis(f"Hash {algo} cracked: {hash_str} -> {found}", "Hash Cracker")
    
    save_scan(hash_str, "hash_crack", out, project_name=project)
